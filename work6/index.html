<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Clock Simulator (Fixed Logic)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --clock-body: #6ab7ff;
            --clock-face: #222;
            --hand-color: #fff;
            --pin-up: #ffd700;
            --pin-down: #3e2723;
            --btn-wheel: #ffffff;
            --btn-hover: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
        }

        /* --- DISPLAY BOX --- */
        .display-box {
            position: relative;
            background-color: #fff;
            padding: 70px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .swap-btn {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .swap-btn:hover { background-color: #555; }

        /* --- RUBIKS BODY --- */
        .rubiks-body {
            width: 320px;
            height: 320px;
            background-color: var(--clock-body);
            border-radius: 45px;
            position: relative;
            padding: 15px;
            box-shadow: inset 0 0 25px rgba(0,0,0,0.15), 0 10px 20px rgba(0,0,0,0.15);
            transition: transform 0.4s ease-in-out; /* Animasi Flip Halus */
        }

        .clock-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            justify-items: center;
            align-items: center;
        }

        .clock-face {
            width: 75px;
            height: 75px;
            background-color: var(--clock-face);
            border-radius: 50%;
            position: relative;
            border: 3px solid #ccc;
            box-sizing: border-box;
        }

        .clock-face::after {
            content: ''; position: absolute;
            top: 4px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background-color: #999; border-radius: 50%;
        }

        .hand {
            position: absolute; bottom: 50%; left: 50%;
            width: 6px; height: 30px;
            background-color: var(--hand-color);
            transform-origin: bottom center;
            border-radius: 3px;
            transition: transform 0.2s cubic-bezier(0.4, 2.0, 0.4, 0.8);
            z-index: 1;
        }
        .hand::before {
            content: ''; position: absolute; bottom: -5px; left: -5px;
            width: 16px; height: 16px; background-color: var(--hand-color); border-radius: 50%;
        }

        /* PINS */
        .pin {
            position: absolute; width: 24px; height: 24px;
            border-radius: 50%; border: 2px solid rgba(0,0,0,0.3);
            cursor: pointer; transition: all 0.2s; z-index: 10;
        }
        .pin:hover { transform: scale(1.1); }
        .pin.top-left { top: 92px; left: 92px; }
        .pin.top-right { top: 92px; right: 92px; }
        .pin.bottom-left { bottom: 92px; left: 92px; }
        .pin.bottom-right { bottom: 92px; right: 92px; }

        /* --- WHEELS (CORNER BUTTONS) --- */
        .wheel-control {
            position: absolute; display: flex; flex-direction: column; gap: 5px; z-index: 15;
        }
        .ctrl-tl { top: 15px; left: 15px; }
        .ctrl-tr { top: 15px; right: 15px; }
        .ctrl-bl { bottom: 15px; left: 15px; }
        .ctrl-br { bottom: 15px; right: 15px; }

        .wheel-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: 1px solid #ccc; background-color: var(--btn-wheel);
            color: #333; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .wheel-btn:active { background-color: #ddd; transform: scale(0.95); }
        .wheel-btn:hover { background-color: var(--btn-hover); }

        .wheel-label {
            position: absolute; font-size: 0.7rem; font-weight: bold; color: #888;
            width: 100%; text-align: center; pointer-events: none;
        }
        .ctrl-tl .wheel-label, .ctrl-tr .wheel-label { top: -18px; }
        .ctrl-bl .wheel-label, .ctrl-br .wheel-label { bottom: -18px; }

        /* PANEL */
        .panel {
            background-color: white; padding: 20px; border-radius: 12px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 600px;
        }
        .btn-action {
            border: none; padding: 10px 20px; font-size: 0.95rem;
            border-radius: 8px; cursor: pointer; color: white; font-weight: 600;
        }
        .btn-random { background-color: #9c27b0; }
        .btn-reset { background-color: #f44336; }
        .btn-download { background-color: #2196F3; }

        .side-indicator {
            position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%);
            font-weight: bold; color: #555; letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <div class="display-box">
        <button class="swap-btn" onclick="swapSide()">ðŸ”„ FLIP SIDE</button>

        <!-- Controls Visual -->
        <div class="wheel-control ctrl-tl">
            <div class="wheel-label">UL</div>
            <button class="wheel-btn" onclick="userTurn(0, -1)">â†º</button>
            <button class="wheel-btn" onclick="userTurn(0, 1)">â†»</button>
        </div>
        <div class="wheel-control ctrl-tr">
            <div class="wheel-label">UR</div>
            <button class="wheel-btn" onclick="userTurn(1, -1)">â†º</button>
            <button class="wheel-btn" onclick="userTurn(1, 1)">â†»</button>
        </div>
        <div class="wheel-control ctrl-bl">
            <button class="wheel-btn" onclick="userTurn(2, -1)">â†º</button>
            <button class="wheel-btn" onclick="userTurn(2, 1)">â†»</button>
            <div class="wheel-label">DL</div>
        </div>
        <div class="wheel-control ctrl-br">
            <button class="wheel-btn" onclick="userTurn(3, -1)">â†º</button>
            <button class="wheel-btn" onclick="userTurn(3, 1)">â†»</button>
            <div class="wheel-label">DR</div>
        </div>

        <div class="rubiks-body">
            <div class="clock-grid" id="clockGrid"></div>
            <!-- Pins -->
            <div class="pin top-left" id="pin0" onclick="togglePin(0)"></div>
            <div class="pin top-right" id="pin1" onclick="togglePin(1)"></div>
            <div class="pin bottom-left" id="pin2" onclick="togglePin(2)"></div>
            <div class="pin bottom-right" id="pin3" onclick="togglePin(3)"></div>
            <div class="side-indicator" id="sideLabel">FRONT SIDE</div>
        </div>
    </div>

    <div class="panel">
        <button class="btn-action btn-random" onclick="randomiseClock()">Scramble</button>
        <button class="btn-action btn-reset" onclick="resetClock()">Reset</button>
        <button class="btn-action btn-download" onclick="downloadImage()">Download</button>
    </div>

    <script>
        // --- DATA STATE ---
        // 0-8: Front Side, 9-17: Back Side
        let clockState = new Array(18).fill(0);
        // Pins: true=UP (Active Front), false=DOWN (Active Back)
        // 0:TL, 1:TR, 2:BL, 3:BR (Relative to Front)
        let pinState = [false, false, false, false];
        let isFrontSide = true;

        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
        });

        // --- CORE MECHANICS (THE FIX) ---

        // Fungsi yang dipanggil oleh tombol HTML
        // visualIndex: 0(UL), 1(UR), 2(DL), 3(DR) berdasarkan apa yang user LIHAT
        // visualDir: 1 (CW sesuai jam dinding yg dilihat), -1 (CCW)
        function userTurn(visualIndex, visualDir) {
            let physicalWheelIndex;
            let physicalDir;

            if (isFrontSide) {
                // Di Front, Visual sama dengan Fisik
                physicalWheelIndex = visualIndex; 
                physicalDir = visualDir; 
            } else {
                // Di Back, posisi tertukar kiri-kanan
                // Visual UL (0) -> Fisik TR (1)
                // Visual UR (1) -> Fisik TL (0)
                // Visual DL (2) -> Fisik DR (3)
                // Visual DR (3) -> Fisik DL (2)
                const mapBackToFront = [1, 0, 3, 2];
                physicalWheelIndex = mapBackToFront[visualIndex];

                // Di Back, jika kita putar CW (searah jarum jam visual),
                // poros fisik sebenarnya berputar CCW dilihat dari depan.
                physicalDir = -visualDir;
            }

            applyMove(physicalWheelIndex, physicalDir);
            renderAll();
        }

        // Menerapkan rotasi ke KEDUA SISI
        // wheelIdx: 0(TL), 1(TR), 2(BL), 3(BR) (Fisik / Front Perspective)
        // dir: +1 (CW Front), -1 (CCW Front)
        function applyMove(wheelIdx, dir) {
            
            // --- 1. EFEK SISI DEPAN (FRONT) ---
            // Sudut Front yang sesuai selalu berputar
            // Mapping Wheel ke Index Jam Front (0, 2, 6, 8)
            const frontCornerIndices = [0, 2, 6, 8];
            const targetFrontCorner = frontCornerIndices[wheelIdx];
            
            // Putar sudut depan
            clockState[targetFrontCorner] = normalize(clockState[targetFrontCorner] + dir);

            // Cek Pin untuk Cross Depan
            // Jika Pin pada roda yang diputar sedang UP (true), Cross ikut berputar
            const frontCrossIndices = [1, 3, 4, 5, 7]; // Atas, Kiri, Tengah, Kanan, Bawah
            
            if (pinState[wheelIdx] === true) {
                // Putar semua bagian cross depan
                frontCrossIndices.forEach(idx => {
                    clockState[idx] = normalize(clockState[idx] + dir);
                });
            }


            // --- 2. EFEK SISI BELAKANG (BACK) ---
            // Poros tembus ke belakang.
            // Arah putaran di belakang berlawanan dengan arah poros depan (karena dilihat dari sisi sebaliknya).
            // Jadi kita gunakan: -dir
            
            const backDir = -dir;

            // Sudut Belakang yang sesuai selalu berputar
            // Mapping Wheel Fisik ke Index Jam Back.
            // Wheel 0 (Front TL) tembus ke Back TR (Index 11)
            // Wheel 1 (Front TR) tembus ke Back TL (Index 9)
            // Wheel 2 (Front BL) tembus ke Back DR (Index 17)
            // Wheel 3 (Front DR) tembus ke Back DL (Index 15)
            const backCornerIndices = [11, 9, 17, 15]; 
            const targetBackCorner = backCornerIndices[wheelIdx];

            // Putar sudut belakang
            clockState[targetBackCorner] = normalize(clockState[targetBackCorner] + backDir);

            // Cek Pin untuk Cross Belakang
            // Cross belakang aktif jika Pin sedang DOWN (false)
            const backCrossIndices = [10, 12, 13, 14, 16]; // Mapping jam cross di belakang
            
            if (pinState[wheelIdx] === false) {
                // Putar semua bagian cross belakang
                backCrossIndices.forEach(idx => {
                    clockState[idx] = normalize(clockState[idx] + backDir);
                });
            }
        }

        // Helper supaya jam tetap 0-11
        function normalize(val) {
            return (val % 12 + 12) % 12;
        }


        // --- RENDERING ---
        function renderAll() {
            renderClocks();
            renderPins();
        }

        function renderClocks() {
            const grid = document.getElementById('clockGrid');
            grid.innerHTML = '';
            
            const startIndex = isFrontSide ? 0 : 9;

            for (let i = 0; i < 9; i++) {
                const hourValue = clockState[startIndex + i];
                const degrees = hourValue * 30;

                const clockDiv = document.createElement('div');
                clockDiv.className = 'clock-face';
                
                const handDiv = document.createElement('div');
                handDiv.className = 'hand';
                handDiv.style.transform = `rotate(${degrees}deg)`;

                clockDiv.appendChild(handDiv);
                grid.appendChild(clockDiv);
            }
            document.getElementById('sideLabel').innerText = isFrontSide ? "FRONT SIDE" : "BACK SIDE";
        }

        function renderPins() {
            const colorUp = 'var(--pin-up)';
            const colorDown = 'var(--pin-down)';

            for (let i = 0; i < 4; i++) {
                const pinEl = document.getElementById(`pin${i}`);
                let isUp = pinState[i];
                let visualUp = isFrontSide ? isUp : !isUp;

                pinEl.style.backgroundColor = visualUp ? colorUp : colorDown;
                pinEl.style.transform = visualUp ? 'scale(1.15)' : 'scale(0.85)';
                pinEl.style.boxShadow = visualUp ? '0 5px 10px rgba(0,0,0,0.3)' : 'inset 0 3px 6px rgba(0,0,0,0.6)';
            }
        }

        function swapSide() {
            isFrontSide = !isFrontSide;
            // Animasi flip
            const body = document.querySelector('.rubiks-body');
            body.style.transform = "rotateY(90deg)"; // Mulai flip
            setTimeout(() => {
                renderAll();
                body.style.transform = "rotateY(0deg)"; // Selesai flip
            }, 400); // Setengah dari transition duration CSS
        }

        function togglePin(index) {
            pinState[index] = !pinState[index];
            renderPins();
        }

        function randomiseClock() {
            for (let i = 0; i < 18; i++) clockState[i] = Math.floor(Math.random() * 12);
            for (let i = 0; i < 4; i++) pinState[i] = Math.random() < 0.5;
            renderAll();
        }

        function resetClock() {
            clockState.fill(0);
            pinState = [false, false, false, false]; // All pins down (standard solved state setup)
            isFrontSide = true;
            renderAll();
        }

        // --- DOWNLOAD ---
        async function downloadImage() {
            const wrapper = document.createElement('div');
            Object.assign(wrapper.style, {
                position: 'fixed', left: '-9999px', top: '0',
                display: 'flex', gap: '50px', backgroundColor: '#fff',
                padding: '50px', alignItems: 'flex-start',
                fontFamily: 'sans-serif'
            });

            wrapper.appendChild(createStaticDOM(true));
            wrapper.appendChild(createStaticDOM(false));
            document.body.appendChild(wrapper);

            try {
                const canvas = await html2canvas(wrapper, { scale: 2, backgroundColor: "#ffffff" });
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'rubiks_clock.png',
                            types: [{ accept: { 'image/png': ['.png'] } }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                    } catch (e) {}
                } else {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'rubiks_clock.png';
                    link.href = url;
                    link.click();
                }
            } catch (err) {
                console.error(err);
            } finally {
                document.body.removeChild(wrapper);
            }
        }

        function createStaticDOM(isFront) {
            const container = document.createElement('div');
            container.style.textAlign = 'center';

            const body = document.createElement('div');
            Object.assign(body.style, {
                width: '300px', height: '300px', backgroundColor: '#6ab7ff', 
                borderRadius: '40px', position: 'relative', padding: '15px',
                boxShadow: 'inset 0 0 20px rgba(0,0,0,0.2)'
            });

            const grid = document.createElement('div');
            Object.assign(grid.style, {
                display: 'grid', width: '100%', height: '100%',
                gridTemplateColumns: 'repeat(3, 1fr)', gridTemplateRows: 'repeat(3, 1fr)',
                justifyItems: 'center', alignItems: 'center'
            });

            const startIndex = isFront ? 0 : 9;
            for (let i = 0; i < 9; i++) {
                const hour = clockState[startIndex + i];
                const face = document.createElement('div');
                Object.assign(face.style, {
                    width: '70px', height: '70px', backgroundColor: '#222',
                    borderRadius: '50%', border: '2px solid #ddd', position: 'relative'
                });
                
                const hand = document.createElement('div');
                Object.assign(hand.style, {
                    position: 'absolute', bottom: '50%', left: '50%',
                    width: '4px', height: '28px', backgroundColor: '#fff',
                    transformOrigin: 'bottom center', transform: `rotate(${hour * 30}deg)`,
                    borderRadius: '2px'
                });
                face.appendChild(hand);
                grid.appendChild(face);
            }
            body.appendChild(grid);

            // Pins for screenshot
            const positions = [ {t:'85px', l:'85px'}, {t:'85px', r:'85px'}, {b:'85px', l:'85px'}, {b:'85px', r:'85px'} ];
            for(let i=0; i<4; i++) {
                const p = document.createElement('div');
                let isUp = pinState[i];
                let visualUp = isFront ? isUp : !isUp;
                Object.assign(p.style, {
                    position: 'absolute', width: '20px', height: '20px', borderRadius: '50%',
                    border: '2px solid rgba(0,0,0,0.2)', backgroundColor: visualUp ? '#ffd700' : '#3e2723',
                    zIndex: '10', transform: visualUp ? 'scale(1.1)' : 'scale(0.9)', ...positions[i]
                });
                body.appendChild(p);
            }
            container.appendChild(body);
            
            const label = document.createElement('h3');
            label.innerText = isFront ? 'FRONT' : 'BACK';
            label.style.marginTop = '15px'; label.style.color = '#333';
            container.appendChild(label);

            return container;
        }

    </script>
</body>
</html>