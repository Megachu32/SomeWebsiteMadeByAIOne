<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pocket Base</title>
<style>
    /* --- CSS VARIABLES & RESET --- */
    :root {
        --bg: #f4f4f9;
        --sidebar-bg: #ffffff;
        --border: #ddd;
        --primary: #6200ea;
        --text: #333;
        --danger: #d32f2f;
        --success: #388e3c;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* --- LAYOUT --- */
    #app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
    
    /* LEFT PANEL (LIST) */
    #list-panel { width: 350px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
    #list-header { padding: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: #fff; }
    #list-content { flex: 1; overflow-y: auto; padding: 10px; }
    
    /* RIGHT PANEL (DETAIL) */
    #detail-panel { flex: 1; background: var(--bg); display: flex; flex-direction: column; position: relative; }
    #detail-header { padding: 10px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; height: 50px; }
    #detail-content { flex: 1; overflow-y: auto; padding: 20px; }
    #empty-state { text-align: center; color: #888; margin-top: 50px; }

    /* MOBILE RESPONSIVE OVERRIDES */
    @media (max-width: 768px) {
        #list-panel { width: 100%; position: absolute; top: 0; bottom: 0; left: 0; transition: transform 0.3s ease; }
        #detail-panel { width: 100%; position: absolute; top: 0; bottom: 0; right: 0; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
        
        /* Mobile States */
        body.view-detail #list-panel { transform: translateX(-20%); opacity: 0; pointer-events: none; }
        body.view-detail #detail-panel { transform: translateX(0); }
    }

    /* --- UI ELEMENTS --- */
    button { cursor: pointer; border: none; background: transparent; padding: 8px; border-radius: 4px; font-size: 16px; }
    button:active { background: #eee; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-icon { font-size: 1.2rem; }
    
    input[type="text"], textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-family: inherit; }
    
    /* ITEMS IN LIST */
    .list-item { background: #fff; border: 1px solid var(--border); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; }
    .list-item:active { background: #f0f0f0; }
    .list-item .meta { margin-left: 10px; flex: 1; }
    .list-item .title { font-weight: bold; display: block; }
    .list-item .desc { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-item .type-badge { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; }
    
    /* CHECKBOX MODE */
    .select-checkbox { margin-right: 10px; display: none; transform: scale(1.3); }
    body.select-mode .select-checkbox { display: block; }
    
    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 80vh; overflow-y: auto; position: relative; }
    .modal.active { display: flex; }
    .modal-close-top { position: absolute; top: 10px; right: 10px; font-size: 1.2rem; cursor: pointer; padding: 5px; }
    
    /* --- COMPONENT STYLES --- */
    .item-description-box { background: #eef; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9rem; color: #556; font-style: italic; }

    /* Note */
    .note-editor { width: 100%; height: 300px; resize: vertical; font-family: monospace; }
    
    /* Tasks */
    .task-row { display: flex; align-items: center; margin-bottom: 8px; background: #fff; padding: 8px; border: 1px solid #eee; border-radius: 4px; }
    .task-controls { margin-left: auto; display: flex; gap: 5px; }
    .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; width: 100%; }
    .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
    
    /* Cells */
    .cells-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .cell-item { border: 1px solid #ccc; padding: 10px; min-height: 80px; border-radius: 4px; position: relative; }
    .cell-item textarea { width: 100%; height: 100%; border: none; background: transparent; resize: none; }
    .cell-color { position: absolute; bottom: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 1px solid #999; }
    
    /* Script */
    .console-box { background: #222; color: #0f0; font-family: monospace; padding: 10px; margin-top: 10px; border-radius: 4px; min-height: 50px; white-space: pre-wrap; }

    /* Categories Manager */
    .cat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .cat-controls button { font-size: 1.2rem; padding: 0 5px; }
    .hidden { display: none !important; }

</style>
</head>
<body>

    <div id="list-panel">
        <div id="list-header">
            <div>
                <button class="btn-icon" onclick="toggleSelectMode()">‚òëÔ∏è</button>
                <button class="btn-icon" id="trash-btn" onclick="deleteSelected()" disabled>üóëÔ∏è</button>
            </div>
            <div>
                <button class="btn-icon" onclick="openCatModal()">‚öôÔ∏è</button>
                <button class="btn-icon" onclick="openCreateModal()">‚ûï</button>
            </div>
        </div>
        <div id="list-content">
            </div>
        <div style="padding:10px; border-top:1px solid #ddd; display:flex; gap:10px;">
            <button onclick="saveToFile()" style="flex:1;">Save JSON</button>
            <button onclick="document.getElementById('file-input').click()" style="flex:1;">Load JSON</button>
            <input type="file" id="file-input" hidden onchange="loadFromFile(this)">
        </div>
    </div>

    <div id="detail-panel">
        <div id="detail-header">
            <button class="btn-icon" onclick="closeDetail()" style="display:none;" id="back-btn">‚¨ÖÔ∏è Back</button>
            <span id="detail-title" style="font-weight:bold; margin-left:10px;"></span>
            <button onclick="exportCurrentItem()" style="font-size:0.8rem;">Export Item</button>
        </div>
        <div id="detail-content">
            <div id="empty-state">Select an item to view details</div>
            <div id="item-workspace" class="hidden">
                <div id="detail-desc" class="item-description-box"></div>
                <div id="workspace-body"></div>
            </div>
        </div>
    </div>

    <div id="modal-create" class="modal-overlay">
        <div class="modal">
            <div class="modal-close-top" onclick="closeModals()">‚úñ</div>
            <h3>Create New</h3>
            
            <label>Title</label>
            <input type="text" id="new-title" placeholder="Item Title">

            <label>Description</label>
            <textarea id="new-desc" placeholder="Brief description..." style="height:60px;"></textarea>

            <label>Categories (separate with ;)</label>
            <input type="text" id="new-cat-str" placeholder="e.g. Work; Urgent">

            <label>Type</label>
            <select id="new-type">
                <option value="note">Note</option>
                <option value="task">Task</option>
                <option value="cells">Cells</option>
                <option value="script">Code</option>
            </select>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-primary" onclick="createItem()">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-cat" class="modal-overlay">
        <div class="modal">
            <div class="modal-close-top" onclick="closeModals()">‚úñ</div>
            <h3>Manage Categories</h3>
            <div id="cat-list-container"></div>
            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <input type="text" id="new-cat-name" placeholder="New Category Name">
                <button onclick="addNewCategory()">Add</button>
            </div>
        </div>
    </div>
    
    <div id="modal-import" class="modal-overlay">
        <div class="modal">
            <div class="modal-close-top" onclick="closeModals()">‚úñ</div>
            <h3>Import Item</h3>
            <textarea id="import-area" style="height:100px" placeholder="Paste JSON string here"></textarea>
            <button class="btn-primary" onclick="processImport()">Import</button>
        </div>
    </div>

<script src="library.js"></script>

<script>
    // --- STATE MANAGEMENT ---
    let db = {
        items: [],
        categories: [
            { id: 'cat_default', name: 'General', visible: true, priority: 1 }
        ]
    };

    let currentItemId = null;
    let selectMode = false;

    // --- INIT ---
    window.onload = () => {
        const saved = localStorage.getItem('pocketbase_db');
        if (saved) db = JSON.parse(saved);
        renderList();
        
        // Mobile Back Button Logic
        if(window.innerWidth <= 768) {
            document.getElementById('back-btn').style.display = 'block';
        }
    };

    function saveData() {
        localStorage.setItem('pocketbase_db', JSON.stringify(db));
        renderList();
    }

    // --- CORE LIST FUNCTIONS ---
    function renderList() {
        const container = document.getElementById('list-content');
        container.innerHTML = '';
        
        // Sort Categories by Priority
        const sortedCats = [...db.categories].sort((a,b) => a.priority - b.priority);

        sortedCats.forEach(cat => {
            if(!cat.visible) return;

            // Find items that belong to this category
            // Logic: db.items now have 'catIds' (array) or legacy 'catId' (string)
            // We show the item under this header if the item includes this cat.id
            const items = db.items.filter(i => {
                if(i.catIds && Array.isArray(i.catIds)) return i.catIds.includes(cat.id);
                return i.catId === cat.id; // Legacy support
            });
            
            if(items.length === 0) return;

            const catHeader = document.createElement('div');
            catHeader.style.padding = "5px 10px";
            catHeader.style.background = "#eee";
            catHeader.style.fontWeight = "bold";
            catHeader.style.fontSize = "0.8rem";
            catHeader.innerText = cat.name;
            container.appendChild(catHeader);

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <input type="checkbox" class="select-checkbox" data-id="${item.id}" onclick="event.stopPropagation()">
                    <div class="meta">
                        <span class="title">${esc(item.title)}</span>
                        <span class="type-badge">${item.type}</span> 
                    </div>
                `;
                div.onclick = (e) => {
                    if(!selectMode) openItem(item.id);
                    else {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                container.appendChild(div);
            });
        });
    }

    // --- ITEM DETAIL LOGIC ---
    function openItem(id) {
        currentItemId = id;
        const item = db.items.find(i => i.id === id);
        if(!item) return;

        // UI Shift for Mobile
        document.body.classList.add('view-detail');
        
        document.getElementById('detail-title').innerText = item.title;
        document.getElementById('empty-state').classList.add('hidden');
        
        // Show Description
        const descBox = document.getElementById('detail-desc');
        if(item.desc) {
            descBox.innerText = item.desc;
            descBox.classList.remove('hidden');
        } else {
            descBox.classList.add('hidden');
        }

        const workspace = document.getElementById('item-workspace');
        workspace.classList.remove('hidden');
        
        const bodyContainer = document.getElementById('workspace-body');
        bodyContainer.innerHTML = ''; // Clear prev

        // RENDER BASED ON TYPE
        if (item.type === 'note') renderNote(item, bodyContainer);
        else if (item.type === 'task') renderTask(item, bodyContainer);
        else if (item.type === 'cells') renderCells(item, bodyContainer);
        else if (item.type === 'script') renderScript(item, bodyContainer);
    }

    function closeDetail() {
        document.body.classList.remove('view-detail');
        currentItemId = null;
    }

    // 1. NOTE TYPE
    function renderNote(item, container) {
        const textarea = document.createElement('textarea');
        textarea.className = 'note-editor';
        textarea.value = item.content || '';
        textarea.oninput = () => {
            item.content = textarea.value;
            saveData();
        };
        container.appendChild(textarea);
    }

    // 2. TASK TYPE
    function renderTask(item, container) {
        // Control Bar
        const controls = document.createElement('div');
        controls.innerHTML = `
            <button onclick="addTaskItem('check')">+ Check</button>
            <button onclick="addTaskItem('radio')">+ Radio</button>
            <button onclick="addTaskItem('progress')">+ Progress</button>
            <button onclick="addTaskItem('tally')">+ Tally</button>
        `;
        container.appendChild(controls);
        
        const listContainer = document.createElement('div');
        listContainer.style.marginTop = "20px";
        
        if(!item.content) item.content = [];

        item.content.forEach((task, index) => {
            const row = document.createElement('div');
            row.className = 'task-row';
            
            // Logic per task sub-type
            let inputHTML = '';
            
            if(task.type === 'check') {
                inputHTML = `<input type="checkbox" ${task.val ? 'checked' : ''} onchange="updateTaskVal(${index}, this.checked)">`;
            } else if (task.type === 'radio') {
                inputHTML = `
                    <input type="text" placeholder="Grp" value="${task.group || 'g1'}" style="width:40px; font-size:0.7rem;" onchange="updateTaskGroup(${index}, this.value)">
                    <input type="radio" name="radio-${item.id}-${task.group || 'g1'}" ${task.val ? 'checked' : ''} onchange="updateTaskRadio(${index}, '${task.group || 'g1'}')">
                `;
            } else if (task.type === 'tally') {
                inputHTML = `
                    <button onclick="updateTaskTally(${index}, -1)">-</button>
                    <span style="margin:0 10px; font-weight:bold;">${task.val || 0}</span>
                    <button onclick="updateTaskTally(${index}, 1)">+</button>
                `;
            } else if (task.type === 'progress') {
                inputHTML = `
                    <div style="width:100%">
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                            <span>Progress</span>
                            <span>${task.val || 0} / ${task.max || 100}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${((task.val||0)/(task.max||100))*100}%"></div>
                        </div>
                        <input type="range" min="0" max="${task.max||100}" value="${task.val||0}" style="width:100%" oninput="updateTaskVal(${index}, parseInt(this.value))">
                    </div>
                `;
            }

            row.innerHTML = `
                <div style="flex:1;">
                    <input type="text" value="${task.label}" placeholder="Label" style="border:none; font-weight:bold; width:100%;" onchange="updateTaskLabel(${index}, this.value)">
                    <div style="margin-top:5px; display:flex; align-items:center; gap:10px;">
                        ${inputHTML}
                    </div>
                </div>
                <button style="color:red;" onclick="removeTaskItem(${index})">X</button>
            `;
            listContainer.appendChild(row);
        });
        container.appendChild(listContainer);
    }

    // 3. CELLS TYPE
    function renderCells(item, container) {
        container.innerHTML = `<button onclick="addCell()">+ Add Cell</button><br><br>`;
        const grid = document.createElement('div');
        grid.className = 'cells-grid';
        
        if(!item.content) item.content = [];

        item.content.forEach((cell, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'cell-item';
            wrapper.style.backgroundColor = cell.color || '#ffffff';
            
            const txt = document.createElement('textarea');
            txt.value = cell.text || '';
            txt.oninput = (e) => {
                item.content[index].text = e.target.value;
                saveData();
            };

            const colorPicker = document.createElement('input');
            colorPicker.type = 'color';
            colorPicker.className = 'cell-color';
            colorPicker.value = cell.color || '#ffffff';
            colorPicker.onchange = (e) => {
                item.content[index].color = e.target.value;
                saveData();
                wrapper.style.backgroundColor = e.target.value;
            };

            const delBtn = document.createElement('button');
            delBtn.innerText = 'x';
            delBtn.style.position = 'absolute';
            delBtn.style.top = '0';
            delBtn.style.right = '0';
            delBtn.style.background = 'rgba(255,255,255,0.5)';
            delBtn.onclick = () => {
                item.content.splice(index, 1);
                saveData();
                openItem(item.id); 
            };

            wrapper.appendChild(txt);
            wrapper.appendChild(colorPicker);
            wrapper.appendChild(delBtn);
            grid.appendChild(wrapper);
        });
        container.appendChild(grid);
    }

    // 4. SCRIPT/CODE TYPE (UPDATED)
    function renderScript(item, container) {
        const info = document.createElement('p');
        info.innerHTML = "<small>Type the function call from your <code>library.js</code>. E.g., <code>myCustomFunc()</code></small>";
        
        const area = document.createElement('textarea');
        area.className = 'note-editor';
        area.style.background = '#eee';
        area.style.height = '100px';
        area.value = item.content || '';
        area.placeholder = 'myRandomNumberGenerator()';
        area.oninput = () => {
            item.content = area.value;
            saveData();
        };

        const runBtn = document.createElement('button');
        runBtn.className = 'btn-primary';
        runBtn.innerText = 'Run Function';
        
        const consoleOut = document.createElement('div');
        consoleOut.className = 'console-box';
        consoleOut.id = 'script-console';

        runBtn.onclick = () => {
            consoleOut.innerText = '> Executing...';
            
            try {
                // We assume the user types a function call available in global scope (from library.js)
                // We use eval() here to allow the user to type "func(1, 2)"
                const result = window.eval(item.content); 
                
                if(result !== undefined) {
                    consoleOut.innerText = '> Result: ' + result;
                } else {
                    consoleOut.innerText = '> Done (No return value)';
                }
            } catch (err) {
                consoleOut.innerText = '> ERROR: ' + err.message;
                consoleOut.innerText += '\n> (Did you create library.js?)';
            }
        };

        container.appendChild(info);
        container.appendChild(area);
        container.appendChild(runBtn);
        container.appendChild(consoleOut);
    }


    // --- TASK HELPERS ---
    function addTaskItem(type) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content.push({ type: type, label: 'New Task', val: 0, max: 100, group: 'g1' });
        saveData();
        openItem(currentItemId);
    }
    function removeTaskItem(index) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content.splice(index, 1);
        saveData();
        openItem(currentItemId);
    }
    function updateTaskLabel(index, val) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content[index].label = val;
        saveData();
    }
    function updateTaskVal(index, val) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content[index].val = val;
        saveData();
        openItem(currentItemId); 
    }
    function updateTaskGroup(index, val) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content[index].group = val;
        saveData();
    }
    function updateTaskRadio(index, group) {
        const item = db.items.find(i => i.id === currentItemId);
        item.content.forEach(t => {
            if(t.type === 'radio' && t.group === group) t.val = false;
        });
        item.content[index].val = true;
        saveData();
    }
    function updateTaskTally(index, delta) {
        const item = db.items.find(i => i.id === currentItemId);
        if(!item.content[index].val) item.content[index].val = 0;
        item.content[index].val += delta;
        saveData();
        openItem(currentItemId);
    }

    // --- CELL HELPERS ---
    function addCell() {
        const item = db.items.find(i => i.id === currentItemId);
        item.content.push({ text: '', color: '#ffeb3b' }); 
        saveData();
        openItem(currentItemId);
    }

    // --- MODAL & CREATE (UPDATED) ---
    function openCreateModal() {
        document.getElementById('modal-create').classList.add('active');
        // Clear inputs
        document.getElementById('new-title').value = '';
        document.getElementById('new-desc').value = '';
        document.getElementById('new-cat-str').value = '';
    }

    function createItem() {
        const title = document.getElementById('new-title').value || 'Untitled';
        const desc = document.getElementById('new-desc').value || '';
        const type = document.getElementById('new-type').value;
        const catStr = document.getElementById('new-cat-str').value;

        // Process Categories (Split by ;)
        let finalCatIds = [];
        
        if (catStr.trim() === "") {
             // Default if empty
            finalCatIds.push(db.categories[0].id);
        } else {
            const rawCats = catStr.split(';').map(s => s.trim()).filter(s => s !== "");
            
            rawCats.forEach(catName => {
                // Check if exists
                let existingCat = db.categories.find(c => c.name.toLowerCase() === catName.toLowerCase());
                if(existingCat) {
                    finalCatIds.push(existingCat.id);
                } else {
                    // Create new category automatically
                    const newId = 'cat_' + Date.now() + Math.floor(Math.random()*1000);
                    db.categories.push({
                        id: newId,
                        name: catName,
                        visible: true,
                        priority: db.categories.length + 1
                    });
                    finalCatIds.push(newId);
                }
            });
        }

        const newItem = {
            id: crypto.randomUUID(),
            created: Date.now(),
            title: title,
            desc: desc,
            type: type,
            catIds: finalCatIds, // New Array format
            content: (type === 'task' || type === 'cells') ? [] : ''
        };

        db.items.unshift(newItem); 
        saveData();
        closeModals();
        renderList();
        renderCatManager(); // Update cat manager in case we added new ones
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    // --- CATEGORY MANAGER ---
    function openCatModal() {
        document.getElementById('modal-cat').classList.add('active');
        renderCatManager();
    }

    function renderCatManager() {
        const cont = document.getElementById('cat-list-container');
        cont.innerHTML = '';
        db.categories.sort((a,b) => a.priority - b.priority).forEach((c, idx) => {
            const row = document.createElement('div');
            row.className = 'cat-row';
            row.innerHTML = `
                <div>
                    <input type="checkbox" ${c.visible ? 'checked' : ''} onchange="toggleCatVis('${c.id}')">
                    <span>${c.name}</span>
                </div>
                <div class="cat-controls">
                    <button onclick="moveCat('${c.id}', -1)">‚¨ÜÔ∏è</button>
                    <button onclick="moveCat('${c.id}', 1)">‚¨áÔ∏è</button>
                </div>
            `;
            cont.appendChild(row);
        });
    }
    
    function addNewCategory() {
        const name = document.getElementById('new-cat-name').value;
        if(!name) return;
        db.categories.push({
            id: 'cat_' + Date.now(),
            name: name,
            visible: true,
            priority: db.categories.length + 1
        });
        document.getElementById('new-cat-name').value = '';
        saveData();
        renderCatManager();
        renderList();
    }

    function toggleCatVis(id) {
        const c = db.categories.find(x => x.id === id);
        c.visible = !c.visible;
        saveData();
        renderList();
    }

    function moveCat(id, dir) {
        const idx = db.categories.findIndex(c => c.id === id);
        const swapIdx = idx + dir;
        if(swapIdx < 0 || swapIdx >= db.categories.length) return;
        
        const temp = db.categories[idx].priority;
        db.categories[idx].priority = db.categories[swapIdx].priority;
        db.categories[swapIdx].priority = temp;
        
        db.categories.sort((a,b) => a.priority - b.priority);
        
        saveData();
        renderCatManager();
        renderList();
    }

    // --- IMPORT / EXPORT ---
    function saveToFile() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "pocketbase_" + Date.now() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function loadFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loaded = JSON.parse(e.target.result);
                if(loaded.items && loaded.categories) {
                    db = loaded;
                    saveData();
                    renderList();
                    alert("Loaded successfully!");
                } else {
                    alert("Invalid JSON format");
                }
            } catch(err) { alert("Error reading file"); }
        };
        reader.readAsText(file);
    }

    function exportCurrentItem() {
        const item = db.items.find(i => i.id === currentItemId);
        const json = JSON.stringify(item);
        navigator.clipboard.writeText(json).then(() => {
            alert("Item JSON copied to clipboard!");
        }).catch(() => {
            prompt("Copy this JSON:", json);
        });
    }

    // New Header Import Button
    const headerBtns = document.querySelector('#list-header div:last-child');
    const impBtn = document.createElement('button');
    impBtn.className = 'btn-icon';
    impBtn.innerText = 'üì•';
    impBtn.onclick = () => document.getElementById('modal-import').classList.add('active');
    headerBtns.insertBefore(impBtn, headerBtns.firstChild);

    function processImport() {
        const str = document.getElementById('import-area').value;
        try {
            const partial = JSON.parse(str);
            if(partial.title && partial.type) {
                partial.id = crypto.randomUUID(); 
                partial.created = Date.now();
                db.items.unshift(partial);
                saveData();
                renderList();
                closeModals();
                alert("Imported: " + partial.title);
            } else {
                alert("Invalid item data");
            }
        } catch(e) {
            alert("JSON Parse Error");
        }
    }

    // --- UTILS ---
    function toggleSelectMode() {
        selectMode = !selectMode;
        document.body.classList.toggle('select-mode', selectMode);
        document.getElementById('trash-btn').disabled = !selectMode;
    }
    
    function deleteSelected() {
        if(!confirm("Delete selected items?")) return;
        const checks = document.querySelectorAll('.select-checkbox:checked');
        const ids = Array.from(checks).map(c => c.getAttribute('data-id'));
        db.items = db.items.filter(i => !ids.includes(i.id));
        saveData();
        renderList();
        toggleSelectMode(); 
    }

    function esc(str) {
        if(!str) return '';
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

</script>
</body>
</html>
